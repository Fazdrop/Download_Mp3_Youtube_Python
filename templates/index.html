<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YT Audio Downloader - Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --glow-color-1: #ff00c1;
        --glow-color-2: #9a00ff;
        --glow-color-3: #00e5ff;
        --bg-color: #121212;
        --card-bg: rgba(255, 255, 255, 0.1);
        --card-border: rgba(255, 255, 255, 0.2);
        --text-color: #f0f0f0;
        --subtle-text: #a0a0a0;
        --success-color: #00ff9d;
        --error-color: #ff4d4d;
      }

      body {
        font-family: "Inter", sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        background: var(--bg-color);
        color: var(--text-color);
        overflow: hidden;
        position: relative;
      }

      /* Animated Gradient Background */
      body::before {
        content: "";
        position: absolute;
        width: 500px;
        height: 500px;
        border-radius: 50%;
        background-image: conic-gradient(
          var(--glow-color-1),
          var(--glow-color-2),
          var(--glow-color-3),
          var(--glow-color-1)
        );
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        filter: blur(150px);
        animation: rotate-glow 15s linear infinite;
      }

      @keyframes rotate-glow {
        from {
          transform: translate(-50%, -50%) rotate(0deg);
        }
        to {
          transform: translate(-50%, -50%) rotate(360deg);
        }
      }

      .container {
        position: relative;
        z-index: 1;
        width: 100%;
        max-width: 500px;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 24px;
        padding: 40px;
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        text-align: center;
        animation: float 6s ease-in-out infinite;
      }

      @keyframes float {
        0% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-10px);
        }
        100% {
          transform: translateY(0px);
        }
      }

      h1 {
        font-size: 28px;
        font-weight: 700;
        margin: 0 0 10px 0;
      }

      p.subtitle {
        color: var(--subtle-text);
        margin-bottom: 30px;
      }

      .input-wrapper {
        position: relative;
        width: 100%;
      }

      .input-wrapper svg {
        position: absolute;
        left: 18px;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 20px;
        color: var(--subtle-text);
      }

      #url {
        width: 100%;
        padding: 16px 16px 16px 50px;
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid var(--card-border);
        border-radius: 12px;
        color: var(--text-color);
        font-size: 16px;
        box-sizing: border-box;
        transition: all 0.3s ease;
      }

      #url:focus {
        outline: none;
        border-color: var(--glow-color-3);
        box-shadow: 0 0 15px rgba(0, 229, 255, 0.3);
      }

      #preview-section {
        margin-top: 25px;
        text-align: left;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 12px;
        padding: 15px;
        display: none; /* Initially hidden */
        align-items: center;
        gap: 15px;
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.5s, transform 0.5s;
      }

      #preview-section.visible {
        display: flex;
        opacity: 1;
        transform: translateY(0);
      }

      #video-thumbnail {
        width: 120px;
        height: 68px;
        border-radius: 8px;
        object-fit: cover;
        background-color: #2a2a2a;
      }

      #video-title {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-color);
      }

      #download-button {
        width: 100%;
        padding: 16px;
        margin-top: 25px;
        background-image: linear-gradient(
          45deg,
          var(--glow-color-1),
          var(--glow-color-2)
        );
        border: none;
        border-radius: 12px;
        color: white;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      #download-button:hover {
        transform: scale(1.05);
        box-shadow: 0 0 20px rgba(154, 0, 255, 0.5);
      }

      #download-button:active {
        transform: scale(1.02);
      }

      .progress-section {
        margin-top: 25px;
        display: none;
        opacity: 0;
        transition: opacity 0.5s;
      }

      .progress-section.visible {
        display: block;
        opacity: 1;
      }

      #progress-container {
        height: 10px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 5px;
        overflow: hidden;
      }

      #progress-bar {
        width: 0%;
        height: 100%;
        background-image: linear-gradient(
          90deg,
          var(--glow-color-2),
          var(--glow-color-3)
        );
        border-radius: 5px;
        transition: width 0.4s ease;
      }

      #status {
        margin-top: 15px;
        font-size: 14px;
        color: var(--subtle-text);
        min-height: 20px;
      }

      /* Custom Alert Modal */
      #custom-alert {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s;
      }
      #custom-alert.visible {
        display: flex;
        opacity: 1;
      }
      .alert-box {
        background: rgba(40, 40, 40, 0.9);
        border: 1px solid var(--card-border);
        padding: 30px;
        border-radius: 16px;
        text-align: center;
        max-width: 350px;
        transform: scale(0.9);
        transition: transform 0.3s;
      }
      #custom-alert.visible .alert-box {
        transform: scale(1);
      }
      .alert-box p {
        margin: 0 0 20px 0;
        font-size: 16px;
      }
      .alert-box button {
        padding: 10px 25px;
        background-image: linear-gradient(
          45deg,
          var(--glow-color-2),
          var(--glow-color-3)
        );
        border: none;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Audio Extractor</h1>
      <p class="subtitle">Ekstrak audio dari video YouTube dengan mudah.</p>

      <form id="download-form" onsubmit="startDownload(event)">
        <div class="input-wrapper">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244"
            />
          </svg>
          <input
            type="text"
            id="url"
            name="url"
            placeholder="Tempel URL YouTube di sini"
            required
            oninput="handleURLInput(event)"
          />
        </div>

        <div id="preview-section">
          <img
            id="video-thumbnail"
            src="https://placehold.co/120x68/1a1a1a/333?text=Preview"
            alt="Video Thumbnail"
          />
          <p id="video-title">Judul video akan muncul di sini.</p>
        </div>

        <button type="submit" id="download-button">Unduh Audio</button>
      </form>

      <div class="progress-section">
        <div id="progress-container">
          <div id="progress-bar"></div>
        </div>
        <div id="status"></div>
      </div>
    </div>

    <div id="custom-alert">
      <div class="alert-box">
        <p id="alert-message">Pesan notifikasi.</p>
        <button onclick="closeAlert()">Tutup</button>
      </div>
    </div>

    <script>
      // DOM Elements
      const urlInput = document.getElementById("url");
      const previewSection = document.getElementById("preview-section");
      const videoThumbnail = document.getElementById("video-thumbnail");
      const videoTitle = document.getElementById("video-title");
      const progressSection = document.querySelector(".progress-section");
      const progressBar = document.getElementById("progress-bar");
      const statusDiv = document.getElementById("status");
      const customAlert = document.getElementById("custom-alert");
      const alertMessage = document.getElementById("alert-message");

      let currentEventSource = null;

      // --- Panggilan API Pratinjau ke Backend ---
      async function fetchVideoInfo(videoUrl) {
        console.log("Menghubungi backend untuk info:", videoUrl);
        try {
          // Mengirim permintaan ke endpoint /get-info di server Flask Anda
          const response = await fetch("/get-info", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ url: videoUrl }),
          });

          if (!response.ok) {
            const errorData = await response
              .json()
              .catch(() => ({ error: "Gagal mem-parsing respons error." }));
            return {
              success: false,
              error: errorData.error || "Terjadi kesalahan pada server.",
            };
          }

          const data = await response.json();
          return data; // Backend mengembalikan format { success: true, title: ..., thumbnail: ... }
        } catch (error) {
          console.error("Fetch error:", error);
          return { success: false, error: "Tidak dapat terhubung ke server." };
        }
      }

      // --- Fungsi UI ---

      function showAlert(message) {
        alertMessage.textContent = message;
        customAlert.classList.add("visible");
      }

      function closeAlert() {
        customAlert.classList.remove("visible");
      }

      // --- Debounce untuk mencegah panggilan API berlebihan ---
      let debounceTimer;
      function handleURLInput(event) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(async () => {
          const url = event.target.value;
          if (
            url &&
            (url.includes("youtube.com") || url.includes("youtu.be"))
          ) {
            // Validasi sederhana
            previewSection.classList.add("visible");
            videoTitle.textContent = "Mencari info video...";
            videoThumbnail.src =
              "https://placehold.co/120x68/1a1a1a/333?text=Wait";

            const info = await fetchVideoInfo(url);
            if (info.success) {
              videoThumbnail.src = info.thumbnail;
              videoTitle.textContent = info.title;
            } else {
              videoTitle.textContent =
                info.error || "Gagal mendapatkan info video.";
              videoThumbnail.src =
                "https://placehold.co/120x68/1a1a1a/e04f4f?text=Error";
            }
          } else {
            // Sembunyikan pratinjau jika input tidak valid atau kosong
            previewSection.classList.remove("visible");
          }
        }, 500); // Jeda 500ms setelah pengguna berhenti mengetik/paste
      }

      function startDownload(e) {
        e.preventDefault();
        if (currentEventSource) {
          currentEventSource.close();
        }
        const url = urlInput.value;
        if (!url) {
          showAlert("Silakan masukkan URL YouTube terlebih dahulu.");
          return;
        }

        progressSection.classList.add("visible");
        progressBar.style.width = "0%";
        progressBar.style.background =
          "linear-gradient(90deg, var(--glow-color-2), var(--glow-color-3))";
        statusDiv.textContent = "Menghubungkan ke server...";

        currentEventSource = new EventSource(
          "/download?url=" + encodeURIComponent(url)
        );

        currentEventSource.onmessage = function (event) {
          try {
            const data = JSON.parse(event.data);
            updateProgress(data);
          } catch (err) {
            console.error("Gagal mem-parsing data:", err);
            statusDiv.textContent = "Terjadi kesalahan saat menerima data.";
          }
        };

        currentEventSource.onerror = function (error) {
          console.error("Koneksi SSE gagal:", error);
          if (currentEventSource) currentEventSource.close();
          statusDiv.textContent = "Koneksi ke server gagal. Coba lagi nanti.";
          progressBar.style.width = "100%";
          progressBar.style.background = "var(--error-color)";
        };
      }

      function updateProgress(data) {
        switch (data.status) {
          case "downloading":
            const percent = Math.min(parseFloat(data.percent) || 0, 100);
            progressBar.style.width = `${percent}%`;
            statusDiv.textContent = `Mengunduh... ${percent.toFixed(
              1
            )}% | Kecepatan: ${data.speed || "N/A"}`;
            break;
          case "processing":
            progressBar.style.width = "100%";
            statusDiv.textContent = "Memproses audio, hampir selesai...";
            break;
          case "completed":
            progressBar.style.width = "100%";
            progressBar.style.background = "var(--success-color)";
            statusDiv.textContent = `Selesai! File "${
              data.filename || "audio.mp3"
            }" siap.`;
            showAlert("Unduhan telah selesai!");
            if (currentEventSource) currentEventSource.close();
            break;
          case "error":
            statusDiv.textContent = `Kesalahan: ${data.message}`;
            progressBar.style.width = "100%";
            progressBar.style.background = "var(--error-color)";
            if (currentEventSource) currentEventSource.close();
            break;
        }
      }
    </script>
  </body>
</html>
